# 服务架构

<cite>
**本文档中引用的文件**  
- [index.ts](file://server/src/index.ts#L1-L102)
- [ecosystem.config.js](file://server/ecosystem.config.js#L1-L23)
- [game.ts](file://server/src/rooms/game.ts#L1-L799)
- [lobby.ts](file://server/src/rooms/lobby.ts#L1-L58)
- [UserManager.ts](file://server/src/UserManager.ts#L1-L149)
- [sgs.ts](file://server/src/core/sgs.ts#L1-L799)
- [extensions.config.ts](file://server/src/core/extensions.config.ts#L1-L10)
- [auth.ts](file://server/src/routes/auth.ts#L1-L59)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [系统架构概述](#系统架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能与可扩展性设计](#性能与可扩展性设计)
8. [进程管理与故障恢复](#进程管理与故障恢复)
9. [日志与监控](#日志与监控)
10. [生产环境部署建议](#生产环境部署建议)

## 简介
本文档详细介绍了基于Node.js和Colyseus框架的resgsv1服务器端系统架构设计。文档从`index.ts`入口点开始，深入解析了服务启动流程、路由配置、中间件加载机制以及基于PM2的进程管理策略。系统采用WebSocket实现实时通信，支持游戏房间集群和数据库交互，具备良好的可扩展性和高可用性。通过分析系统架构图，展示了HTTP服务器、WebSocket网关、游戏房间和数据库之间的关系，并提供了性能监控和日志记录的最佳实践。

## 项目结构
resgsv1项目采用分层模块化设计，主要分为客户端（client）和服务器端（server）两大模块。服务器端基于TypeScript开发，使用Colyseus作为实时游戏服务器框架，实现了游戏房间、用户管理、认证授权等核心功能。

```mermaid
graph TD
A[服务器端 server] --> B[build]
A --> C[src]
A --> D[loadtest]
A --> E[test]
A --> F[ecosystem.config.js]
A --> G[package.json]
A --> H[tsconfig.json]
C --> I[core]
C --> J[db]
C --> K[extensions]
C --> L[middleware]
C --> M[models]
C --> N[rooms]
C --> O[routes]
C --> P[scripts]
C --> Q[utils]
C --> R[UserManager.ts]
C --> S[index.ts]
```

**Diagram sources**
- [server](file://server)
- [src](file://server/src)

**Section sources**
- [project_structure](file://project_structure)

## 核心组件
resgsv1服务器的核心组件包括：`index.ts`作为服务入口，`UserManager.ts`负责用户会话管理，`game.ts`和`lobby.ts`定义游戏房间和大厅逻辑，`sgs.ts`提供游戏核心数据和逻辑，`auth.ts`处理用户认证，以及`ecosystem.config.js`配置PM2进程管理。

**Section sources**
- [index.ts](file://server/src/index.ts#L1-L102)
- [UserManager.ts](file://server/src/UserManager.ts#L1-L149)
- [game.ts](file://server/src/rooms/game.ts#L1-L799)
- [lobby.ts](file://server/src/rooms/lobby.ts#L1-L58)
- [sgs.ts](file://server/src/core/sgs.ts#L1-L799)
- [auth.ts](file://server/src/routes/auth.ts#L1-L59)

## 系统架构概述
resgsv1采用微服务架构思想，以Colyseus为核心构建实时游戏服务器。系统通过HTTP服务器接收客户端请求，经由WebSocket网关建立持久连接，游戏房间集群处理具体游戏逻辑，数据库存储用户数据和游戏状态。

```mermaid
graph LR
Client[客户端] --> HTTP[HTTP服务器]
HTTP --> WS[WebSocket网关]
WS --> Lobby[大厅房间]
WS --> Game[游戏房间]
Game --> DB[(数据库)]
Game --> Cache[(缓存)]
Admin[管理后台] --> Monitor[监控面板]
Monitor --> WS
LoadTest[压力测试] --> Client
```

**Diagram sources**
- [index.ts](file://server/src/index.ts#L1-L102)
- [game.ts](file://server/src/rooms/game.ts#L1-L799)
- [lobby.ts](file://server/src/rooms/lobby.ts#L1-L58)

## 详细组件分析

### 服务启动流程分析
系统启动流程从`index.ts`文件开始，初始化Express应用，配置CORS和body-parser中间件，注册认证、管理、应用路由，创建Colyseus服务器实例，并定义大厅和游戏房间。

```mermaid
sequenceDiagram
participant Main as 主进程
participant Express as Express应用
participant Colyseus as Colyseus服务器
participant DB as 数据库
participant Room as 游戏房间
Main->>Main : 启动服务
Main->>DB : connectToDatabase()
DB-->>Main : 连接成功
Main->>Main : start()
Main->>Express : 创建app实例
Express->>Express : 配置CORS
Express->>Express : 配置body-parser
Express->>Express : 注册/auth路由
Express->>Express : 注册/admin路由
Express->>Express : 注册/app路由
Main->>Colyseus : 创建服务器实例
Colyseus->>Colyseus : 定义大厅房间
Colyseus->>Colyseus : 定义游戏房间
Express->>Express : 添加监控中间件
Express->>Express : 添加调试中间件
Colyseus->>Colyseus : 监听端口12699
Colyseus-->>Main : 服务器启动成功
```

**Diagram sources**
- [index.ts](file://server/src/index.ts#L1-L102)

**Section sources**
- [index.ts](file://server/src/index.ts#L1-L102)

### 用户管理组件分析
`UserManager`类负责管理在线用户会话，包括用户登录、加入大厅、加入房间、离开房间等操作。它维护了一个全局的在线用户映射表，存储用户数据、令牌、最后活动时间和房间信息。

```mermaid
classDiagram
class UserManager {
+static inst : UserManager
+onlinePlayers : { [username : string] : PlayerSession }
+login(user : DbUser) : string
+joinLobby(username : string, client : Client) : void
+leaveLobby(client : Client) : void
+joinRoom(username : string, room : GameRoom, client : Client) : void
+leaveRoom(username : string, roomId : string, reconnectToken? : string) : void
+getPlayerRooms(username : string) : RoomInfo[]
+findPlayerByClinet(sessionId : string) : PlayerSession | null
+broadcast(message : string) : void
}
class PlayerSession {
+userdata : DbUser
+token : string
+lastActive : Date
+lobbyClient : Client | null
+rooms : { [roomId : string] : RoomConnection }
}
class RoomConnection {
+room : GameRoom
+client : Client
+reconnectToken? : string
}
class DbUser {
+_id : string
+username : string
+profile : UserProfile
+privileges : UserPrivileges
+status : UserStatus
+statsByMode : { [mode : string] : GameStats }
}
class UserProfile {
+avatar : string
+title : string
}
class UserPrivileges {
+admin : boolean
+betaTester : boolean
}
class UserStatus {
+isMuted : boolean
+muteExpires? : Date
+isGameBanned : boolean
+gameBanExpires? : Date
}
class GameStats {
+matches : number
+wins : number
+escapes : number
}
UserManager "1" --> "0..*" PlayerSession : 包含
PlayerSession "1" --> "1" DbUser : 关联
PlayerSession "1" --> "0..*" RoomConnection : 包含
```

**Diagram sources**
- [UserManager.ts](file://server/src/UserManager.ts#L1-L149)

**Section sources**
- [UserManager.ts](file://server/src/UserManager.ts#L1-L149)

### 游戏房间组件分析
`GameRoom`类继承自Colyseus的Room类，处理游戏房间的生命周期事件和消息通信。它管理玩家状态、旁观者、投降、举报、屏蔽等游戏逻辑，并与数据库交互记录游戏结果。

```mermaid
flowchart TD
Start([房间创建]) --> OnCreate["onCreate(options)"]
OnCreate --> SetState["设置房间状态"]
OnCreate --> SetMetadata["设置元数据"]
OnCreate --> UpdateLobby["更新大厅"]
OnCreate --> SetOptions["更新房间选项"]
OnCreate --> RegisterMessages["注册消息处理器"]
RegisterMessages --> ReadyHandler["ready消息"]
RegisterMessages --> StartHandler["start消息"]
RegisterMessages --> ChatHandler["chat消息"]
RegisterMessages --> SurrenderHandler["game_surrender消息"]
RegisterMessages --> JubaoHandler["jubao消息"]
RegisterMessages --> PingbiHandler["pingbi消息"]
OnAuth["onAuth(client, options)"] --> ValidateUser["验证用户身份"]
ValidateUser --> CheckToken["检查令牌"]
CheckToken --> CheckReconnect["检查重连令牌"]
CheckReconnect --> CheckPassword["检查房间密码"]
CheckReconnect --> CheckSpectate["检查旁观权限"]
CheckReconnect --> CheckBetaTester["检查测试资格"]
CheckReconnect --> CheckGameBan["检查游戏封禁"]
ValidateUser --> ReturnResult["返回验证结果"]
OnJoin["onJoin(client, options)"] --> CheckReconnect["检查重连"]
CheckReconnect --> RestoreState["恢复玩家状态"]
CheckReconnect --> JoinRoom["加入房间"]
JoinRoom --> UpdateMetadata["更新元数据"]
JoinRoom --> UpdateLobby["更新大厅"]
OnLeave["onLeave(client, consented)"] --> CheckPlayer["检查玩家类型"]
CheckPlayer --> Spectator["旁观者离开"]
CheckPlayer --> Player["玩家离开"]
Player --> CheckConsent["检查是否同意"]
Player --> HandleEscape["处理逃跑"]
Player --> GenerateToken["生成重连令牌"]
Player --> UpdateOwner["更新房主"]
Player --> Cleanup["清理数据"]
Player --> UpdateMetadata["更新元数据"]
Player --> UpdateLobby["更新大厅"]
Player --> Disconnect["房间为空则断开"]
HandleGameOver["handleGameOver(wins, reason)"] --> RecordResult["记录游戏结果"]
RecordResult --> UpdateUserStats["更新用户统计数据"]
RecordResult --> UpdateGeneralStats["更新武将统计数据"]
RecordResult --> AdjustReputation["调整信誉分"]
RecordResult --> CleanupGame["清理游戏状态"]
```

**Diagram sources**
- [game.ts](file://server/src/rooms/game.ts#L1-L799)

**Section sources**
- [game.ts](file://server/src/rooms/game.ts#L1-L799)

### 大厅房间组件分析
`CustomLobbyRoom`类继承自Colyseus的LobbyRoom类，管理大厅房间的用户连接和断开事件，维护在线玩家数量，并处理用户重连逻辑。

```mermaid
sequenceDiagram
participant Client as 客户端
participant Lobby as 大厅房间
participant UserManager as 用户管理器
Client->>Lobby : 连接请求
Lobby->>Lobby : onAuth验证身份
alt 验证失败
Lobby-->>Client : 拒绝连接
else 验证成功
Lobby->>Lobby : onJoin加入大厅
Lobby->>Lobby : 增加玩家计数
Lobby->>UserManager : joinLobby记录连接
UserManager->>UserManager : 存储lobbyClient
UserManager->>Client : 检查重连令牌
alt 存在重连令牌
Client-->>Client : 发送reconnectToken
end
Lobby-->>Client : 连接成功
end
Client->>Lobby : 断开连接
Lobby->>Lobby : onLeave离开大厅
Lobby->>Lobby : 减少玩家计数
Lobby->>UserManager : leaveLobby清理连接
UserManager->>UserManager : 清除lobbyClient
Lobby-->>Client : 断开确认
```

**Diagram sources**
- [lobby.ts](file://server/src/rooms/lobby.ts#L1-L58)

**Section sources**
- [lobby.ts](file://server/src/rooms/lobby.ts#L1-L58)

## 依赖关系分析
系统各组件之间存在明确的依赖关系，通过依赖注入和模块化设计实现松耦合。核心依赖关系包括：`index.ts`依赖`UserManager`、`UserService`等服务类；`game.ts`依赖`UserManager`、`UserService`、`ReputationService`等；`auth.ts`依赖`UserService`和`UserManager`。

```mermaid
graph TD
index["index.ts"] --> UserManager["UserManager.ts"]
index --> UserService["UserService.ts"]
index --> BanService["BanService.ts"]
index --> game["game.ts"]
index --> lobby["lobby.ts"]
index --> auth["auth.ts"]
index --> admin["admin.ts"]
game --> UserManager
game --> UserService
game --> GeneralService["GeneralStatsService.ts"]
game --> ReputationService["ReputationService.ts"]
auth --> UserService
auth --> UserManager
lobby --> UserManager
sgs["sgs.ts"] --> extensions["extensions.config.ts"]
sgs --> package["Package.ts"]
sgs --> card["card.types.ts"]
sgs --> general["general.type.ts"]
sgs --> skill["skill.types.ts"]
```

**Diagram sources**
- [index.ts](file://server/src/index.ts#L1-L102)
- [game.ts](file://server/src/rooms/game.ts#L1-L799)
- [auth.ts](file://server/src/routes/auth.ts#L1-L59)
- [lobby.ts](file://server/src/rooms/lobby.ts#L1-L58)
- [sgs.ts](file://server/src/core/sgs.ts#L1-L799)
- [extensions.config.ts](file://server/src/core/extensions.config.ts#L1-L10)

**Section sources**
- [index.ts](file://server/src/index.ts#L1-L102)
- [game.ts](file://server/src/rooms/game.ts#L1-L799)
- [auth.ts](file://server/src/routes/auth.ts#L1-L59)

## 性能与可扩展性设计
系统采用多种设计模式提升性能和可扩展性。通过Colyseus的实时状态同步机制减少网络传输量，使用内存缓存频繁访问的数据，支持水平扩展的房间集群架构。

### 可扩展性设计
系统通过配置文件和环境变量支持灵活的资源分配和实例扩展。PM2配置允许根据CPU核心数自动调整工作进程数量，实现负载均衡。

```mermaid
graph TD
subgraph "客户端"
C1[客户端1]
C2[客户端2]
C3[客户端3]
end
subgraph "负载均衡"
LB[PM2集群]
end
subgraph "服务器实例"
S1[实例1]
S2[实例2]
S3[实例N]
end
subgraph "数据存储"
DB[(数据库)]
Cache[(Redis缓存)]
end
C1 --> LB
C2 --> LB
C3 --> LB
LB --> S1
LB --> S2
LB --> S3
S1 --> DB
S1 --> Cache
S2 --> DB
S2 --> Cache
S3 --> DB
S3 --> Cache
```

**Diagram sources**
- [ecosystem.config.js](file://server/ecosystem.config.js#L1-L23)

**Section sources**
- [ecosystem.config.js](file://server/ecosystem.config.js#L1-L23)

### 性能优化策略
系统采用多项性能优化策略，包括：
- 状态差异同步：仅传输状态变化部分
- 消息批处理：合并多个消息减少网络开销
- 内存缓存：缓存用户数据和房间状态
- 异步处理：非关键操作异步执行

```mermaid
flowchart LR
A[客户端请求] --> B{是否高频操作?}
B --> |是| C[加入消息队列]
B --> |否| D[立即处理]
C --> E[批量处理]
E --> F[状态差异计算]
F --> G[仅发送变化部分]
D --> H[直接响应]
G --> I[客户端更新]
H --> I
I --> J[渲染界面]
```

**Diagram sources**
- [game.ts](file://server/src/rooms/game.ts#L1-L799)
- [index.ts](file://server/src/index.ts#L1-L102)

## 进程管理与故障恢复
系统使用PM2进行进程管理和故障恢复，通过`ecosystem.config.js`配置文件定义应用运行参数，实现自动重启、负载均衡和日志管理。

### PM2配置分析
PM2配置文件定义了应用名称、脚本路径、实例数量、执行模式等关键参数，确保服务的高可用性和稳定性。

```mermaid
classDiagram
class PM2Config {
+apps : PM2App[]
}
class PM2App {
+name : string
+script : string
+time : boolean
+watch : boolean
+instances : number
+exec_mode : string
+wait_ready : boolean
+env_production : EnvVars
}
class EnvVars {
+NODE_ENV : string
}
PM2Config "1" --> "1..*" PM2App : 包含
```

**Diagram sources**
- [ecosystem.config.js](file://server/ecosystem.config.js#L1-L23)

**Section sources**
- [ecosystem.config.js](file://server/ecosystem.config.js#L1-L23)

### 故障恢复策略
系统实现多层次的故障恢复机制，包括：
- 进程级恢复：PM2自动重启崩溃的进程
- 连接级恢复：WebSocket断线重连和状态恢复
- 数据级恢复：数据库事务和备份机制

```mermaid
sequenceDiagram
participant Process as 进程
participant PM2 as PM2守护进程
participant Client as 客户端
participant Server as 服务器
Process->>Process : 正常运行
alt 进程崩溃
Process->>PM2 : 进程终止
PM2->>PM2 : 检测到崩溃
PM2->>Process : 重启新进程
Process->>Process : 恢复服务
end
Client->>Server : WebSocket连接
alt 网络中断
Server->>Client : 连接丢失
Client->>Server : 尝试重连
Server->>Server : 验证重连令牌
alt 令牌有效
Server->>Client : 恢复会话
Client->>Client : 同步最新状态
else 令牌无效
Server->>Client : 要求重新登录
end
end
```

**Diagram sources**
- [ecosystem.config.js](file://server/ecosystem.config.js#L1-L23)
- [game.ts](file://server/src/rooms/game.ts#L1-L799)
- [UserManager.ts](file://server/src/UserManager.ts#L1-L149)

## 日志与监控
系统集成Colyseus Monitor和Playground工具，提供实时监控和调试功能。同时通过console.log输出关键日志，便于问题排查。

### 监控面板功能
Colyseus Monitor提供房间状态、客户端连接、消息统计等实时监控数据，帮助开发者了解服务器运行状况。

```mermaid
graph TD
A[监控面板] --> B[房间列表]
A --> C[客户端连接]
A --> D[消息统计]
A --> E[性能指标]
A --> F[错误日志]
B --> B1[房间ID]
B --> B2[玩家数量]
B --> B3[房间状态]
B --> B4[创建时间]
C --> C1[客户端ID]
C --> C2[连接时间]
C --> C3[IP地址]
C --> C4[状态]
D --> D1[接收消息]
D --> D2[发送消息]
D --> D3[消息类型]
D --> D4[消息频率]
E --> E1[CPU使用率]
E --> E2[内存使用]
E --> E3[网络IO]
E --> E4[延迟]
F --> F1[错误类型]
F --> F2[发生时间]
F --> F3[错误详情]
F --> F4[堆栈跟踪]
```

**Diagram sources**
- [index.ts](file://server/src/index.ts#L1-L102)

**Section sources**
- [index.ts](file://server/src/index.ts#L1-L102)

## 生产环境部署建议
为确保系统在生产环境的稳定运行，建议采取以下部署策略：

### 部署架构
采用多实例部署架构，通过负载均衡器分发流量，确保高可用性和可扩展性。

```mermaid
graph TD
subgraph "公网"
User[用户]
DNS[DNS解析]
end
subgraph "负载均衡"
LB[负载均衡器]
SSL[SSL终止]
end
subgraph "应用层"
S1[服务器实例1]
S2[服务器实例2]
S3[服务器实例N]
end
subgraph "数据层"
MasterDB[(主数据库)]
SlaveDB[(从数据库)]
Redis[(Redis缓存)]
end
User --> DNS
DNS --> LB
LB --> S1
LB --> S2
LB --> S3
S1 --> MasterDB
S1 --> SlaveDB
S1 --> Redis
S2 --> MasterDB
S2 --> SlaveDB
S2 --> Redis
S3 --> MasterDB
S3 --> SlaveDB
S3 --> Redis
```

### 最佳实践
1. **安全配置**：启用HTTPS，配置安全的CORS策略
2. **性能调优**：根据实际负载调整PM2实例数量
3. **监控告警**：设置关键指标的监控和告警
4. **备份策略**：定期备份数据库和重要配置
5. **灰度发布**：采用蓝绿部署或金丝雀发布策略
6. **日志管理**：集中收集和分析日志数据

**Section sources**
- [index.ts](file://server/src/index.ts#L1-L102)
- [ecosystem.config.js](file://server/ecosystem.config.js#L1-L23)
- [README.md](file://server/README.md#L1-L29)