# 角色属性模型

<cite>
**本文档引用文件**   
- [general.type.ts](file://server/src/core/general/general.type.ts)
- [general.ts](file://server/src/core/general/general.ts)
- [simayi.js](file://server/build/extensions/wars/generals/standard/wei/simayi.js)
</cite>

## 目录
1. [引言](#引言)
2. [核心属性定义](#核心属性定义)
3. [GeneralState 接口设计](#generalstate-接口设计)
4. [角色属性初始化过程](#角色属性初始化过程)
5. [属性值验证与边界处理](#属性值验证与边界处理)
6. [武将属性加载示例](#武将属性加载示例)
7. [UML 类图：角色模型关系](#uml-类图角色模型关系)

## 引言
本文档详细阐述了 resgsv1 项目中角色属性模型的设计与实现机制。重点分析了生命值（hp）、最大生命值（maxHp）、体力（energy）、势力（camp）、性别（gender）等核心属性的结构化定义，以及通过 `GeneralState` 接口对角色状态进行约束的方式。文档还展示了从具体武将文件（如司马懿）加载属性的过程，并说明了属性初始化、验证和边界条件处理的逻辑。

## 核心属性定义
在 resgsv1 中，角色（武将）的核心属性通过 `GeneralData` 接口进行定义，位于 `general.type.ts` 文件中。这些属性构成了武将的基础数据结构。

### 属性列表与数据类型
以下是主要角色属性及其数据类型的详细说明：

- **id**: `GeneralId` — 武将的唯一标识符，类型为字符串。
- **name**: `string` — 武将名称。
- **kingdom**: `GeneralKingdom` — 武将所属势力，支持以逗号分隔的多个势力。
- **hp**: `GeneralHp` — 血量，支持多种格式：
  - 单个数字：表示初始体力值与上限相同。
  - 二元数组 `[number, number]`：分别表示初始体力值和初始体力上限。
  - 三元数组 `[number, number, number]`：额外包含初始护盾值。
- **gender**: `Gender` — 性别，使用枚举类型定义。
- **skills**: `string[]` — 技能列表，存储技能名称字符串数组。
- **lord**: `boolean` — 是否为主公。
- **enable**: `boolean` — 是否启用该武将。
- **hidden**: `boolean` — 是否在武将一览中隐藏。
- **package**: `string[]` — 所属扩展包。
- **isDualImage**: `boolean` — 是否启用双头武将特殊插画。
- **isWars**: `boolean` — 是否为国战武将。

### 性别枚举（Gender）
性别使用 `Gender` 枚举进行定义，确保类型安全和语义清晰：

```typescript
export const enum Gender {
    None = 0,       // 无性别
    Male = 1,       // 男
    Female = 2,     // 女
    Doublesex = 9,  // 双性
}
```

**Section sources**
- [general.type.ts](file://server/src/core/general/general.type.ts#L7-L18)

## GeneralState 接口设计
`GeneralData` 接口是角色状态的核心契约，定义了所有武将必须具备的基本属性。该接口通过 TypeScript 的强类型系统确保数据的一致性和可预测性。

### 接口结构分析
`GeneralData` 接口不仅定义了属性名称和类型，还通过 JSDoc 注释提供了清晰的语义说明，便于开发者理解每个字段的用途。

```typescript
export interface GeneralData {
    id: GeneralId;
    name: string;
    kingdom: GeneralKingdom;
    hp: GeneralHp;
    gender: Gender;
    skills: string[];
    lord: boolean;
    enable: boolean;
    hidden: boolean;
    package: string[];
    isDualImage: boolean;
    isWars: boolean;
}
```

此接口作为创建武将实例的基础输入，所有武将配置都必须符合此结构。

**Section sources**
- [general.type.ts](file://server/src/core/general/general.type.ts#L20-L38)

## 角色属性初始化过程
角色属性的初始化在 `General` 类的构造函数中完成，位于 `general.ts` 文件中。该过程包括基础属性设置和扩展属性注入。

### 初始化流程
1. **构造函数接收 `GeneralData` 数据**：传入符合 `GeneralData` 接口的配置对象。
2. **解析势力（kingdom）**：
   - 若 `kingdom` 为数组，则第一个元素为 `kingdom`，第二个为 `kingdom2`（副势力）。
   - 否则，`kingdom` 和 `kingdom2` 均设为同一值。
3. **解析血量（hp）**：
   - 若 `hp` 为数组，则分别提取初始体力值、上限和护盾。
   - 否则，初始体力值和上限均设为该数值，护盾为 0。

### 代码实现
```typescript
public constructor(room: GameRoom, protected data: GeneralData) {
    this.room = room;
    this.id = data.id;
    this.sourceData = {
        // ... 基础属性赋值
        kingdom: 'none',
        kingdom2: 'none',
        hp: 0,
        hpmax: 0,
        shield: 0,
        // ...
    };

    // 解析势力
    if (Array.isArray(this.data.kingdom)) {
        this.sourceData.kingdom = this.data.kingdom[0];
        this.sourceData.kingdom2 = this.data.kingdom[1];
    } else {
        this.sourceData.kingdom = this.sourceData.kingdom2 = this.data.kingdom;
    }

    // 解析血量
    if (Array.isArray(this.data.hp)) {
        this.sourceData.hp = this.data.hp[0];
        this.sourceData.hpmax = this.data.hp[1];
        this.sourceData.shield = this.data.hp.length > 2 ? this.data.hp[2] : 0;
    } else {
        this.sourceData.hp = this.sourceData.hpmax = this.data.hp;
        this.sourceData.shield = 0;
    }
}
```

**Section sources**
- [general.ts](file://server/src/core/general/general.ts#L4-L50)

## 属性值验证与边界处理
系统在初始化时对属性值进行隐式验证，确保数据的有效性。

### 边界条件处理
- **血量数组长度**：若 `hp` 为数组且长度大于 2，则第三项作为护盾值；否则护盾为 0。
- **势力数组长度**：仅支持最多两个势力（主、副），超出部分被忽略。
- **默认值设置**：如 `isWars` 字段使用 `?? false` 确保未定义时默认为 `false`。

这些处理机制防止了无效或缺失数据导致运行时错误。

**Section sources**
- [general.ts](file://server/src/core/general/general.ts#L40-L50)

## 武将属性加载示例
以司马懿（simayi.js）为例，展示如何从具体武将文件中加载角色属性。

### 司马懿配置
```javascript
exports.simayi = sgs.General({
    name: 'wars.simayi',
    kingdom: 'wei',
    hp: 1.5,
    gender: 1 /* Gender.Male */,
    isWars: true,
});
```

### 属性解析过程
1. **name**: `'wars.simayi'` — 设置武将名称。
2. **kingdom**: `'wei'` — 设置势力为“魏”，`kingdom2` 也设为 `'wei'`。
3. **hp**: `1.5` — 非数组，因此初始体力值和上限均为 1.5，护盾为 0。
4. **gender**: `1` — 对应 `Gender.Male`。
5. **isWars**: `true` — 标记为国战武将。

随后通过 `addSkill` 方法添加“反馈”和“鬼才”技能。

**Section sources**
- [simayi.js](file://server/build/extensions/wars/generals/standard/wei/simayi.js#L3-L10)

## UML 类图：角色模型关系
以下类图展示了 `General`、`GeneralData` 和具体武将（如司马懿）之间的关系。

```mermaid
classDiagram
class GeneralData {
+id : GeneralId
+name : string
+kingdom : GeneralKingdom
+hp : GeneralHp
+gender : Gender
+skills : string[]
+lord : boolean
+enable : boolean
+hidden : boolean
+package : string[]
+isDualImage : boolean
+isWars : boolean
}
class General {
-room : GameRoom
-data : GeneralData
+sourceData : { ... }
+id : GeneralId
+name : string
+kingdom : string
+kingdom2 : string
+hp : number
+hpmax : number
+shield : number
+gender : Gender
+skills : string[]
+isDual() : boolean
+sameAs(to : General) : boolean
+getAssetsUrl(type) : string
}
class simayi {
+name : 'wars.simayi'
+kingdom : 'wei'
+hp : 1.5
+gender : Gender.Male
+isWars : true
}
General <-- GeneralData : 使用
General <|-- simayi : 实例化
```

**Diagram sources**
- [general.type.ts](file://server/src/core/general/general.type.ts#L20-L38)
- [general.ts](file://server/src/core/general/general.ts#L4-L195)
- [simayi.js](file://server/build/extensions/wars/generals/standard/wei/simayi.js#L3-L10)